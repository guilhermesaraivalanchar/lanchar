.row
  .col-12
    .card
      .card-body
        h2.card-title Compras
        h6.card-subtitle Realização de compras de produtos e combos



        div#add_produtos
        button#add_produto_botao.btn.btn-primary.waves-effect.waves-light helper='button' Adicionar Produto
        br
        br
        div#add_combos
        button#add_combo_botao.btn.btn-primary.waves-effect.waves-light helper='button' Adicionar Combo

        h5.m-t-20 Usuário
        select#select_usuario.select2.m-b-10.select2-multiple data-placeholder="Escolha um usuário" style=("width: 100%")
          option value="" Escolha um usuário
          - User.where(escola_id: current_user.escola_id).each do |user|
            option id="option_usu_#{user.id}" value="#{user.id}" usuario_nome="#{user.nome}"
              = "#{user.nome}"
        br
        br
        button#add_prod_usu.btn.btn-success.waves-effect.waves-light.m-r-10 type="button" Adicionar

        br
        br
        h4.box-title.m-t-10
          | Lista
        hr
        div#div_confirmacao.comment-widgets


        button#enviar_confirmacao.btn.btn-success.waves-effect.waves-light.m-r-10 type="button" Comprar

javascript:
  var produto_num = 0;
  var combo_num = 0;
  var select_prod_options = "#{@select_prod_options}"
  var select_combo_options = "#{@select_combo_options}"
  var produtos_all_string = "#{@produtos_cardapio_string}"
  var combos_all_string = "#{@combos_cardapio_string}"

  var confirmacao = [];

  produtos_all = []
  produtos_all_preco = []

  prod_card = produtos_all_string.split("...")

  for(i in prod_card){
    prod_dados = prod_card[i].split("::")
    produtos_all[prod_dados[1]] = prod_dados[0]
    produtos_all_preco[prod_dados[1]] = parseFloat(prod_dados[2])
  }

  combos_all = []
  combos_all_preco = []

  comb_card = combos_all_string.split("...")

  for(i in comb_card){
    comb_dados = comb_card[i].split("::")
    combos_all[comb_dados[1]] = comb_dados[0]
    combos_all_preco[comb_dados[1]] = parseFloat(comb_dados[2])
  }

  select_prod_options = replaceAll(select_prod_options,"&lt;","<")
  select_prod_options = replaceAll(select_prod_options,"&gt;",">")
  select_prod_options = replaceAll(select_prod_options,"&#39;","'")

  select_combo_options = replaceAll(select_combo_options,"&lt;","<")
  select_combo_options = replaceAll(select_combo_options,"&gt;",">")
  select_combo_options = replaceAll(select_combo_options,"&#39;","'")



  $("#select_val").change(function(){
    console.log($(this).val())
  })
  $(".select2").select2();

  $("#add_produto_botao").click(function(){
    select_produto = "<div class='row' id='div_select_prod_"+produto_num+"'><div class='col-10'><select id='select_prod_"+produto_num+"' class='select2 m-b-10 select2-multiple' style='width: 100%'>"+select_prod_options+"</select></div><div class='col-2'><button class='btn btn-danger waves-effect waves-light'  onclick='remover_select_prod("+produto_num+")' helper='button'>Remover</button></div><br><br><br></div>"
    $("#add_produtos").append(select_produto);
    $(".select2").select2();
    produto_num++
  })


  $("#add_combo_botao").click(function(){
    select_combo = "<div class='row' id='div_select_combo_"+combo_num+"'><div class='col-10'><select id='select_combo_"+combo_num+"' onchange='dados_combo(this)' combo_param='"+combo_num+"' class='select2 m-b-10 select2-multiple' style='width: 100%'>"+select_combo_options+"</select><br><br><div id='div_combo_"+combo_num+"' style='padding-left: 20px'></div></div><div class='col-2'><button class='btn btn-danger waves-effect waves-light'  onclick='remover_select_combo("+combo_num+")' helper='button'>Remover</button></div></div>"
    $("#add_combos").append(select_combo);
    $(".select2").select2();
    combo_num++
  })

  function replaceAll(str, find, replace) {
    return str.replace(new RegExp(find, 'g'), replace);
  }

  function dados_combo(t){

      $.getJSON("/get_dados_combo", { combo_id: $(t).val() },function(resultado) {
        if (resultado) {

          combo_param = t.getAttribute("combo_param")
          $("#div_combo_"+combo_param).html("")
          

          produto_combo_def_num = 0
          
          for(i in resultado.produtos){
            input_produto_combo = "<input class='string required form-control' disabled='disabled' type='text' id='input_prod_combo_"+combo_param+"_"+produto_combo_def_num+"' value='"+resultado.produtos[i].nome+"' produto_id='"+resultado.produtos[i].id+"'><br><br>"
            $("#div_combo_"+combo_param).append(input_produto_combo)
            produto_combo_def_num++
          }


          produto_combo_num = 0
          for(i in resultado.tipo_produtos){

            select_produto_combo = "<select id='select_nested_prod_combo_"+combo_param+"_"+produto_combo_num+"' class='select2 m-b-10 select2-multiple' style='width: 100%'>"+resultado.tipo_produtos[i].opcoes+"</select><br><br>"
            $("#div_combo_"+combo_param).append(select_produto_combo)
            $(".select2").select2();
            produto_combo_num++
          }

          console.log(resultado);

        } else {
          console.log("NAO DEU");
        }
      })
  }

  var div_confirmacao_num = 0
  $("#add_prod_usu").click(function(){
    //<div class="d-flex flex-row comment-row"><div class="w-100"><h5>Ricardo Martins Rodriguez</h5><div class="m-b-5" id="div_obs"><div>Combo - R$ 12,20</div><div>Combo - R$ 12,20</div><div style="padding-left: 20px">Combo - R$ 12,20</div><div style="padding-left: 20px">Combo - R$ 12,20</div><div>Combo - R$ 12,20</div></div><div class="comment-footer"><span class="text-muted">Total : R$ 56,52</span></div></div></div>
    produtos = []

    user_id = $("#select_usuario").val()

    user_nome = document.getElementById("option_usu_"+user_id).getAttribute("usuario_nome");

    elemento_confirmacao = '<div id="div_confirmacao_usu_'+div_confirmacao_num+'" class="d-flex flex-row comment-row"><div class="w-100"><h5>'+user_nome+'</h5><div class="m-b-5">'
    total = 0
    $('[id^=select_prod_]').each(function(){
      elemento_confirmacao += '<div>'+produtos_all[$(this).val()]+' - R$ '+produtos_all_preco[$(this).val()]+'</div>'
      total = total + produtos_all_preco[$(this).val()]
      produtos.push({tipo: 'p', id: $(this).val()})
    })
    $('[id^=select_combo_]').each(function(){
      produtos_combo = []
      combo_param = this.getAttribute("combo_param");
      elemento_confirmacao += '<div>'+combos_all[$(this).val()]+' - R$ '+combos_all_preco[$(this).val()]+'</div>'
      $('[id^=input_prod_combo_'+combo_param+'_]').each(function(){
        prd_id = this.getAttribute("produto_id");
        elemento_confirmacao += '<div style="padding-left: 20px">'+produtos_all[prd_id]+'</div>'
        produtos_combo.push(prd_id)
      })
      $('[id^=select_nested_prod_combo_'+combo_param+'_]').each(function(){
        prd_id = this.getAttribute("produto_id");
        elemento_confirmacao += '<div style="padding-left: 20px">'+produtos_all[$(this).val()]+'</div>'
        produtos_combo.push($(this).val())
      })
      total = total + combos_all_preco[$(this).val()]
      produtos.push({tipo: 'c', id: $(this).val(), produtos: produtos_combo})
    })

    elemento_confirmacao += '</div><div class="comment-footer"><span class="text-muted">Total : R$ '+total.toFixed(2)+'</span></div></div>'

    elemento_confirmacao += '<div style="padding-left: 17px"><button class="btn btn-danger waves-effect waves-light m-r-10" id="remover_confirmacao_'+div_confirmacao_num+'" onclick="remover_div_confirmacao('+div_confirmacao_num+')" type="button">Remover</button><a helper="button" style="display:none" id="imprimir_confirmacao_'+div_confirmacao_num+'" class="btn waves-effect waves-light btn-info" style="margin-right: 10px" href="/transferencia_gerais/transferencia_pdf/1.pdf" target="_blank">Imprimir</a></div></div>'
  
    $('#div_confirmacao').append(elemento_confirmacao)


    confirmacao.push({div_confirmacao_id: div_confirmacao_num, user_id: user_id, produtos: produtos})

    div_confirmacao_num++

    $("#add_produtos").html("")
    $("#add_combos").html("")
  })

  function remover_div_confirmacao(id){
    console.log("id -- "+id)
    $("#div_confirmacao_usu_"+id).remove();

    for(i in confirmacao){
      console.log("confirmacao[i].div_confirmacao_id -- "+confirmacao[i].div_confirmacao_id)
      console.log("i -- "+i)


      if (confirmacao[i].div_confirmacao_id == id){
        confirmacao.splice(i, 1);
      }
    }


  }


  function remover_select_prod(id){
    console.log("id -- "+id)
    $("#div_select_prod_"+id).remove();



  }

  function remover_select_combo(id){
    console.log("id -- "+id)
    $("#div_select_combo_"+id).remove();

  }

  $("#enviar_confirmacao").click(function(){

    $.getJSON("/enviar_confirmacao_compra", { confirmacao: confirmacao },function(resultado) {
      if (resultado) {
        console.log(resultado)
        if (resultado.status == "OK"){
          for(i in resultado.resposta){
            div_confirmacao_id = resultado.resposta[i].div_confirmacao_id
            transf_geral_id = resultado.resposta[i].transf_geral_id

            $("#remover_confirmacao_"+div_confirmacao_id).hide()
            $("#imprimir_confirmacao_"+div_confirmacao_id).attr("href","/transferencia_gerais/transferencia_pdf/"+transf_geral_id+".pdf");
            $("#imprimir_confirmacao_"+div_confirmacao_id).show()
            for(i in confirmacao){
              if (confirmacao[i].div_confirmacao_id == div_confirmacao_id){
                confirmacao.splice(i, 1);
              }
            }

          }

        }
      } else {
        console.log("NAO DEU");
      }
    })

  })